{% extends "main.html" %}

{% block title %}Login | Chain-Cred{% endblock %}

{% block content %}
<div class="min-h-screen bg-primary-dark text-light flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-primary rounded-2xl shadow-2xl border border-gray-700 p-8 text-center">
        
        <h1 class="text-3xl font-bold mb-4">Login to Chain-Cred</h1>
        <p class="text-light-muted mb-8">Connect your MetaMask wallet to log in to your account.</p>

        <button id="connectAndLoginBtn" 
                class="w-full py-3 px-4 rounded-lg bg-blue-600 text-white font-bold text-lg 
                       shadow-lg hover:bg-blue-500 hover:shadow-blue-500/50 
                       transform hover:-translate-y-0.5 transition duration-300 ease-in-out">
            <ion-icon name="wallet-outline" class="text-lg align-middle mr-2"></ion-icon>
            Connect Wallet & Login
        </button>

        <p class="text-sm text-light-muted mt-6">
            New here? 
            <a href="{{ url_for('routes.login') }}" class="text-blue-400 hover:underline">
                Create an account (Sign Up)
            </a>
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script type="module" src="{{ url_for('static', filename='js/credchain.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loginButton = document.getElementById('connectAndLoginBtn');

        loginButton.addEventListener('click', async () => {
            try {
                // 1. Make sure the connectWallet function is loaded
                if (!window.connectWallet) {
                    alert("Error: connectWallet function not found. Please refresh.");
                    return;
                }

                // 2. Call your connectWallet function from credchain.js
                // This will prompt MetaMask login
                const account = await window.connectWallet();
                
                console.log("Wallet connected:", account);

                // 3. Save the wallet to browser storage
                // This is how the dashboard will know who is logged in
                localStorage.setItem('userWalletAddress', account);

                // 4. Redirect to the dashboard
                alert("Login successful! Redirecting to your dashboard...");
                window.location.href = '/Fdashboard'; // This is the URL for routes.dashboard

            } catch (e) {
                // This will catch errors if the user rejects the connection
                console.error("Wallet connection failed:", e);
                alert("Login failed: " + e.message);
            }
        });
    });
</script>
{% endblock %}